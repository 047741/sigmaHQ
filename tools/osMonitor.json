{"type": "monitor", "name": "RDP over Reverse SSH Tunnel WFP", "description": "Detects svchost hosting RDP termsvcs communicating with the loopback address", "enabled": true, "schedule": {"period": {"interval": 5, "unit": "MINUTES"}}, "inputs": [{"search": {"indices": ["opensearch-security-logs"], "query": {"size": 1, "aggregations": {}, "query": {"bool": {"must": [{"bool": {"must": [{"match": {"winlog.channel": "\"Security\""}}]}}, {"bool": {"must": [{"match": {"winlog.event_id": "\"5156\""}}]}}, {"bool": {"should": [{"bool": {"must": [{"bool": {"must": [{"match": {"winlog.event_data.SourcePort": "\"3389\""}}]}}, {"bool": {"should": [{"match": {"winlog.event_data.DestAddress.keyword": "127.*"}}, {"match": {"winlog.event_data.DestAddress.keyword": "\\:\\:1"}}]}}]}}, {"bool": {"must": [{"bool": {"must": [{"match": {"winlog.event_data.DestPort": "\"3389\""}}]}}, {"bool": {"should": [{"match": {"winlog.event_data.SourceAddress.keyword": "127.*"}}, {"match": {"winlog.event_data.SourceAddress.keyword": "\\:\\:1"}}]}}]}}]}}]}}}}}], "tags": ["Defense Evasion", "Lateral Movement", "T1090", "T1090.001", "T1090.002", "T1021.001"], "triggers": [{"name": "generated-trigger", "severity": "2", "condition": {"script": {"source": "ctx.results[0].hits.total.value > 0", "lang": "painless"}}, "actions": []}], "sigma_meta_data": {"rule_id": "5bed80b6-b3e8-428e-a3ae-d3c757589e41", "threat": [{"tactic": {"id": "TA0005", "reference": "https://attack.mitre.org/tactics/TA0005", "name": "Defense Evasion"}, "framework": "MITRE ATT&CK\u00ae", "technique": []}, {"tactic": {"id": "TA0008", "reference": "https://attack.mitre.org/tactics/TA0008", "name": "Lateral Movement"}, "framework": "MITRE ATT&CK\u00ae", "technique": []}]}, "references": ["https://twitter.com/SBousseaden/status/1096148422984384514", "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Command%20and%20Control/DE_RDP_Tunnel_5156.evtx"]}
